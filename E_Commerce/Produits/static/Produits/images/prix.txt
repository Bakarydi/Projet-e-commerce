
// models.py
from django.db import models
from Acount.models import Utilisateur
from E_Commerce.settings import AUTH_USER_MODEL
from django.utils import timezone


class Categories(models.Model):
    nom_categorie = models.CharField(max_length=30)
    date_ajout = models.DateTimeField(auto_now=True)
    image_categorie = models.ImageField(upload_to="img_categorie")
    description = models.TextField()
    def __str__(self):
        return self.nom_categorie
    
    class Meta : 
        ordering = ['date_ajout']
    


class MesProduits(models.Model):
    image = models.ImageField(upload_to='img_produits')
    nom = models.CharField(max_length=30)
    prix = models.IntegerField()
    description = models.TextField()
    categorie = models.ForeignKey(Categories,on_delete=models.CASCADE)
    date_ajout = models.DateField(auto_now=True)
    def __str__(self):
        return f"{self.nom} à pour prix {self.prix}"
    

class PanierOrder(models.Model):
    user = models.ForeignKey(AUTH_USER_MODEL,on_delete=models.CASCADE)
    order = models.ForeignKey(MesProduits,on_delete=models.CASCADE)
    quantity =  models.IntegerField(default=1)
    ordered = models.BooleanField(default=False)
    date = models.DateField(auto_now=True, blank=True, null=True)
    def __str__(self):
        return f"{self.order.nom} - {self.quantity}"
    
    def total_prix(self):
        return self.order.prix * self.quantity
    
    
        


class Panier(models.Model):
    user = models.OneToOneField(AUTH_USER_MODEL, on_delete=models.CASCADE)
    produits = models.ManyToManyField(PanierOrder)
    
    def __str__(self):
        return f"le panier de {self.user}"
    
    def delete(self, *args, **kwargs):
        for order in self.produits.all():
            order.ordered = True
            order.date = timezone.now()
            order.save()
        
        self.produits.clear()
        super().delete(*args, **kwargs)
    
    
   
// views.py

from django.shortcuts import render, get_object_or_404, redirect
from .models import *
from django.contrib.auth.decorators import login_required
from django.urls import reverse


def accueil(request):
    categories = Categories.objects.all()
    produit = MesProduits.objects.all()
    return render(request,'Produits/Accueil.html',{'produit':produit, 'categories':categories})


def details(request, my_id):
    produit = get_object_or_404(MesProduits,id=my_id)
    print(produit)
    return render(request, 'Produits/detail.html', {'produit': produit})

def produits(request):
    categorie = Categories.objects.all()
    allProduit = MesProduits.objects.all()
    return render(request, 'Produits/Produits.html', {'allProduit': allProduit, 'categorie':categorie})
    
    
def recherches(request):
    if request.method == 'GET':
        user_saisie = request.GET.get('recherche')
        prods = MesProduits.objects.filter(nom__icontains=user_saisie)
        return render(request,'Produits/recherce.html',{'prods':prods})
    return render(request,'Produits/recherce.html')

#  Fonciton pour tout les categories

def prodCategorie(request,id_cate):
    categorie = Categories.objects.all()
    cat = Categories.objects.get(id=id_cate)
    print(cat)
    prodsCategorie = MesProduits.objects.filter(categorie=cat)
    print(prodCategorie)
    return render(request,'Produits/catproduts.html',{'prodsCategorie':prodsCategorie,
                                                      'cate':cat,
                                                      'categorie':categorie})
    


# Fonction pour ajouter dans le panier

def addCart(request, idproduct):
    user = request.user
    product = get_object_or_404(MesProduits, id=idproduct)
    panier, _= Panier.objects.get_or_create(user=user)
    order, created = PanierOrder.objects.get_or_create(user=user, ordered=False, order=product)
    if created:
        panier.produits.add(order)
        panier.save()
    else :
        order.quantity +=1
        order.save()
    return redirect('produits')


#  Fonction pour le panier

def panier(request):
    user = request.user
    panier, create = Panier.objects.get_or_create(user=user)
    allproduct = panier.produits.all()
    total = sum(item.prix() for item in allproduct)
    return render(request,'Produits/panier.html', {'allproduct':allproduct, 'total':total})

 
def supprimer_panier(request):
    if panier := request.user.panier:
        panier.delete()
    return redirect('accueil')

def commander(request):
    return render(request, 'Produits/commander.html')
    

// Template panier

{% include "Produits/header.html" %}

    <main>
        <section class="cart">
                <h1 style =" text-align:center;" class="h1">PANIER</h1>
            <table class="table">
                <thead>
                  <tr>
                    <th scope="col">Produits</th>
                    <th scope="col">Prix</th>
                    <th scope="col">Quantie</th>
                    <th scope="col">Sous-total</th>
                  </tr>
                </thead>
                <tbody>
                    {% for panier  in allproduct %}
                  <tr>
                   
                    <td>
                        <img src=" {{panier.order.image.url}}" width="100px" height="100px" alt="produits">
                    </td>
                    <td>
                        <p style ="font-size: 15px; align-items: center; margin-top: 30px" > {{panier.order.total_prix}} GNF</p>
                       
                    </td>
                    <td class="quantite">
                        <input style="margin-top: 30px; width: 40px;" type="number" class="quantity" value="{{panier.quantity}}" min="1">
                            <a href="" class="btn btn-primary r-0">+</a>
                            <a href="" class="btn btn-primary r-0">-</a>
                    </td>
                    <td>
                        <p style="margin-top: 30px;">10</p>
                    </td>
                    <td scope="row">
                        <a href=" {% url 'supprimer_panier' %} ">
                            supprimer
                        </a>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>

            <div class="cart-actions">
                <a href=""><button onclick="continueShopping()">Poursuivre les achats</button></a>
                <a href=""><button onclick="updateCart()">Mettre à jour le panier</button></a>
            </div>

            <div class="checkout">
                <h3>Total Panier</h3>
                <p>Sous-total : </p>
                <p>Total : {{ total }} </p>
                <a href="{% url 'commander' %}"><button onclick="validateOrder()">Valider la commande</button></a>
                <div class="payment-methods">
                    <img src="visa.png" alt="Visa">
                    <img src="paypal.png" alt="Paypal">
                    <img src="stripe.png" alt="Stripe">
                </div>
            </div>
        </section>
    </main>

    {% include "Produits/footer.html" %}

